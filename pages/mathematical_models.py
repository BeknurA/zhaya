import streamlit as st
import numpy as np
import plotly.graph_objects as go


# --- –§–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥–µ–ª—ñ–Ω–µ –∞—Ä–Ω–∞–ª“ì–∞–Ω —Ñ—É–Ω–∫—Ü–∏—è–ª–∞—Ä (Monod –º–æ–¥–µ–ª—ñ–Ω—ñ“£ –∂–µ“£—ñ–ª–¥–µ—Ç—ñ–ª–≥–µ–Ω —Ç“Ø—Ä—ñ) ---
def fermentation_model(t, pH_start, pH_inf, k_growth, X0):
    """
    –õ–∞–∫—Ç–∞—Ç “õ—ã—à“õ—ã–ª—ã–Ω—ã“£ —Ç“Ø–∑—ñ–ª—É—ñ–Ω–µ –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã pH-—Ç—ã“£ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª–¥—ã —Ç”©–º–µ–Ω–¥–µ—É –º–æ–¥–µ–ª—ñ.

    pH(t) = pH_inf + (pH_start - pH_inf) * exp(-k_growth * t)

    –ú“±–Ω–¥–∞“ì—ã k_growth - –±–∞–∫—Ç–µ—Ä–∏—è–ª–∞—Ä–¥—ã“£ ”©—Å—É –∂—ã–ª–¥–∞–º–¥—ã“ì—ã–Ω–∞ –∂”ô–Ω–µ –±—É—Ñ–µ—Ä–ª—ñ–∫ —Å—ã–π—ã–º–¥—ã–ª—ã“õ“õ–∞ –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞.
    """
    return pH_inf + (pH_start - pH_inf) * np.exp(-k_growth * t)


def show_mathematical_models(lang_choice):
    """
    Streamlit –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–Ω–¥–µ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –º–æ–¥–µ–ª—å–¥–µ—Ä–¥—ñ –∫”©—Ä—Å–µ—Ç–µ–¥—ñ:
    –ü–æ—Å–æ–ª, –§–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏—è –∂”ô–Ω–µ –°—É—à–∫–∞ –ø—Ä–æ—Ü–µ—Å—Ç–µ—Ä—ñ.
    """
    st.title("üî¨ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –º–æ–¥–µ–ª—å–¥–µ—Ä")

    tab1, tab2, tab3 = st.tabs(["–ü–æ—Å–æ–ª", "–§–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏—è", "–°—É—à–∫–∞"])

    # ====================================================================
    # TAB 1: –ü–û–°–û–õ (–¢“±–∑–¥–∞—É) - –ë–µ—Ä—ñ–ª–≥–µ–Ω –∫–æ–¥“õ–∞ –Ω–µ–≥—ñ–∑–¥–µ–ª–≥–µ–Ω
    # ====================================================================
    with tab1:
        st.markdown("<h2 style='color:#667eea;'>1. –ü–æ—Å–æ–ª –ø—Ä–æ—Ü–µ—Å—ñ–Ω—ñ“£ –º–æ–¥–µ–ª—ñ (–î–∏—Ñ—Ñ—É–∑–∏—è)</h2>",
                    unsafe_allow_html=True)

        st.subheader("üìö –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –Ω–µ–≥—ñ–∑")
        # –§–∏–∫–∞ –∑–∞“£—ã (–¥–∏—Ñ—Ñ—É–∑–∏—è)
        st.latex(r"J = -D \frac{\partial C}{\partial x}")
        st.markdown(r"**–ú“±–Ω–¥–∞:** $J$ - —Ç“±–∑ –∞“ì—ã–Ω—ã, $D$ - –¥–∏—Ñ—Ñ—É–∑–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ñ ($m^2/s$), $C$ - –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è")

        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Å–∏–º—É–ª—è—Ü–∏—è
        st.subheader("‚öôÔ∏è –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Å–∏–º—É–ª—è—Ü–∏—è")

        col1, col2 = st.columns(2)
        with col1:
            thickness = st.slider("–ï—Ç “õ–∞–ª—ã“£–¥—ã“ì—ã ($L$, —Å–º)", 1.0, 10.0, 5.0)
            salt_conc = st.slider("–°—ã—Ä—Ç“õ—ã —Ç“±–∑ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Å—ã ($C_0$, %)", 2.0, 6.0, 3.5)

        with col2:
            temp = st.slider("–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ ($T$, ¬∞C)", 0, 10, 4)
            time_hours = st.slider("–£–∞“õ—ã—Ç ($t$, —Å–∞“ì–∞—Ç)", 0, 120, 72)

        # –î–∏—Ñ—Ñ—É–∑–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ñ–Ω –µ—Å–µ–ø—Ç–µ—É (—ç–º–ø–∏—Ä–∏–∫–∞–ª—ã“õ)
        # 0.5e-9 –º¬≤/—Å - –Ω–µ–≥—ñ–∑–≥—ñ –º”ô–Ω. D = D_base * (1 + f(T))
        D_base = 0.5e-9
        D = D_base * (1 + 0.03 * temp) * 1e4  # —Å–º¬≤/—Å–∞“ì–∞—Ç“õ–∞ –∞—É—ã—Å—Ç—ã—Ä—É (3600*10000)

        st.info(f"üîë **–ï—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –¥–∏—Ñ—Ñ—É–∑–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ñ ($D$):** **{D * 3600:.2e} $—Å–º^2/—Å–∞“ì$**")

        x = np.linspace(0, thickness, 100)  # –¢–µ—Ä–µ“£–¥—ñ–∫ (—Å–º)
        t_sec = time_hours * 3600  # –°–µ–∫—É–Ω–¥—Ç–∞—Ä“ì–∞ –∞—É—ã—Å—Ç—ã—Ä—É

        # –ñ–µ“£—ñ–ª–¥–µ—Ç—ñ–ª–≥–µ–Ω –§–∏–∫ –∑–∞“£—ã–Ω—ã“£ —à–µ—à—ñ–º—ñ (–∂–∞—Ä—Ç—ã–ª–∞–π —à–µ–∫—Å—ñ–∑ –æ—Ä—Ç–∞ “Ø—à—ñ–Ω –∂—É—ã“õ—Ç–∞—É)
        # C(x, t) = C_0 * erfc(x / (2*sqrt(D*t)))

        # “ö–æ–ª–∞–π–ª—ã —à–µ—à—ñ–º (–æ—Ä—Ç–∞–ª—ã“õ—Ç–∞“ì—ã –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è–Ω—ã –µ—Å–µ–ø—Ç–µ—É “Ø—à—ñ–Ω)
        # –ë“±–ª –∂–µ—Ä–¥–µ –∂–µ“£—ñ–ª–¥–µ—Ç—ñ–ª–≥–µ–Ω —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª–¥—ã —Ç“Ø—Ä “õ–æ–ª–¥–∞–Ω—ã–ª–∞–¥—ã (—Ç–∞“ì–∞–º–¥—ã“õ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–¥–∞ –∂–∏—ñ “õ–æ–ª–¥–∞–Ω—ã–ª–∞–¥—ã)

        # –¢“±–∑ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Å—ã–Ω—ã“£ —Ç–∞—Ä–∞–ª—É—ã (–∂–µ“£—ñ–ª–¥–µ—Ç—ñ–ª–≥–µ–Ω)
        # C = C_0 * (1 - exp(-k * t / (L^2) * x)) - –±“±–ª —Ç–µ“£–¥–µ—É –§–∏–∫ –∑–∞“£—ã–Ω—ã“£ —à–µ—à—ñ–º—ñ –µ–º–µ—Å
        # –ï“£ “õ–∞—Ä–∞–ø–∞–π—ã–º: –û—Ä—Ç–∞–ª—ã“õ—Ç–∞“ì—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ—Ç—ã –∂—É—ã“õ—Ç–∞—É “Ø—à—ñ–Ω Fourier series “õ–æ–ª–¥–∞–Ω—É“ì–∞ –±–æ–ª–∞–¥—ã,
        # –±—ñ—Ä–∞“õ –±—ñ–∑ “õ–∞—Ä–∞–ø–∞–π—ã–º –¥–∏—Ñ—Ñ—É–∑–∏—è —Ç–µ—Ä–µ“£–¥—ñ–≥—ñ–Ω “õ–æ–ª–¥–∞–Ω–∞–º—ã–∑:

        C_center = salt_conc * (1 - np.exp(- (D * t_sec) / (thickness ** 2)))  # –û—Ä—Ç–∞–ª—ã“õ—Ç–∞“ì—ã –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è–Ω—ã –∂—É—ã“õ—Ç–∞—É

        # –ì—Ä–∞—Ñ–∏–∫ “Ø—à—ñ–Ω: –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è–Ω—ã“£ —Ç–µ—Ä–µ“£–¥—ñ–∫ –±–æ–π—ã–Ω—à–∞ —Ç–∞—Ä–∞–ª—É—ã (–∂—É—ã“õ—Ç–∞—É)
        C = salt_conc * (1 - np.exp(-(x / thickness) ** 2 * D * t_sec / (thickness / 2) ** 2))
        C[C < 0] = 0

        fig = go.Figure()
        fig.add_trace(go.Scatter(x=x, y=C, mode='lines', name='–¢“±–∑ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è—Å—ã'))
        fig.update_layout(
            title="–¢“±–∑–¥—ã“£ –µ—Ç –±–æ–π—ã–Ω—à–∞ —Ç–∞—Ä–∞–ª—É—ã",
            xaxis_title="–¢–µ—Ä–µ“£–¥—ñ–∫ (—Å–º)",
            yaxis_title=f"–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è (%) (C(t) ~ {C_center:.2f}%)",
            yaxis_range=[0, salt_conc * 1.1],
            height=400
        )
        st.plotly_chart(fig, use_container_width=True)

        st.markdown(f"""
        <div style='border-left: 5px solid #667eea; padding: 10px; background: #f0f4ff; border-radius: 5px;'>
        ‚Ä¢ **“ö–æ—Ä—ã—Ç—ã–Ω–¥—ã:** {time_hours} —Å–∞“ì–∞—Ç—Ç–∞ —Ç“±–∑–¥—ã“£ –¥–∏—Ñ—Ñ—É–∑–∏—è —Ç–µ—Ä–µ“£–¥—ñ–≥—ñ ~**{np.sqrt(D * t_sec):.2f} —Å–º**.<br>
        ‚Ä¢ “ö–∞–ª—ã“£–¥—ã“ì—ã {thickness} —Å–º –µ—Ç “Ø—à—ñ–Ω –æ—Ä—Ç–∞–ª—ã“õ—Ç–∞“ì—ã –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è —à–∞–º–∞–º–µ–Ω **{C_center:.2f}%** “õ“±—Ä–∞–π–¥—ã.
        </div>
        """, unsafe_allow_html=True)

    # ====================================================================
    # TAB 2: –§–ï–†–ú–ï–ù–¢–ê–¶–ò–Ø (–ñ–∞“£–∞ —Ç–æ–ª—ã“õ—Ç—ã—Ä—É)
    # ====================================================================
    with tab2:
        st.markdown("<h2 style='color:#667eea;'>2. –§–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥–µ–ª—ñ (pH –¥–∏–Ω–∞–º–∏–∫–∞—Å—ã)</h2>",
                    unsafe_allow_html=True)

        st.subheader("üìö –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –Ω–µ–≥—ñ–∑")
        st.markdown(
            "pH-—Ç—ã“£ —Ç”©–º–µ–Ω–¥–µ—É—ñ —Å“Ø—Ç “õ—ã—à“õ—ã–ª—ã –±–∞–∫—Ç–µ—Ä–∏—è–ª–∞—Ä—ã–Ω—ã“£ (–°“ö–ë) ”©—Å—É—ñ –º–µ–Ω “õ–∞–Ω—Ç—Ç—ã –º–µ—Ç–∞–±–æ–ª–∏–∑–¥–µ—É—ñ–Ω–µ –±–∞–π–ª–∞–Ω—ã—Å—Ç—ã —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª–¥—ã —Ñ—É–Ω–∫—Ü–∏—è–º–µ–Ω —Å–∏–ø–∞—Ç—Ç–∞–ª–∞–¥—ã:")

        st.latex(r"pH(t) = pH_{inf} + (pH_{start} - pH_{inf}) \cdot e^{-k_{growth} t}")

        col_f1, col_f2 = st.columns(2)
        with col_f1:
            pH_start = st.slider("–ë–∞—Å—Ç–∞–ø“õ—ã pH ($pH_{start}$)", 5.5, 6.5, 6.0, 0.1)
            pH_inf = st.slider("–®–µ–∫—Ç—ñ pH ($pH_{inf}$)", 4.5, 5.2, 4.8, 0.1)
        with col_f2:
            k_growth = st.slider("”®—Å—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞—Å—ã ($k_{growth}$, $h^{-1}$)", 0.05, 0.5, 0.15, 0.01)
            time_ferm = st.slider("–£–∞“õ—ã—Ç ($t$, —Å–∞“ì–∞—Ç)", 0, 72, 24, 6)

        target_pH = st.number_input("–ú–∞“õ—Å–∞—Ç—Ç—ã pH", 4.5, 5.5, 5.2, 0.1)

        # –ú–æ–¥–µ–ª—å–¥–µ—É –µ—Å–µ–ø—Ç–µ—É—ñ
        t_values_ferm = np.linspace(0, time_ferm, 100)
        pH_t = fermentation_model(t_values_ferm, pH_start, pH_inf, k_growth, X0=1)  # X0 —Ç–µ–∫ Monod “Ø—à—ñ–Ω “õ–∞–∂–µ—Ç

        # –ú–∞“õ—Å–∞—Ç—Ç—ã —É–∞“õ—ã—Ç—Ç—ã –µ—Å–µ–ø—Ç–µ—É
        if pH_start > target_pH > pH_inf:
            try:
                t_target_ferm = -1 / k_growth * np.log((target_pH - pH_inf) / (pH_start - pH_inf))
            except:
                t_target_ferm = time_ferm + 1
        else:
            t_target_ferm = -1

        # –ì—Ä–∞—Ñ–∏–∫
        fig_ferm = go.Figure()
        fig_ferm.add_trace(go.Scatter(
            x=t_values_ferm,
            y=pH_t,
            mode='lines',
            name='pH –¥–∏–Ω–∞–º–∏–∫–∞—Å—ã',
            line=dict(color='darkred', width=3)
        ))

        fig_ferm.add_hline(y=target_pH, line_dash="dash", line_color="green",
                           annotation_text=f"–ú–∞“õ—Å–∞—Ç—Ç—ã pH: {target_pH:.1f}", annotation_position="top right")

        if 0 < t_target_ferm <= time_ferm:
            fig_ferm.add_vline(x=t_target_ferm, line_dash="dash", line_color="red",
                               annotation_text=f"t (–º–∞“õ—Å–∞—Ç)={t_target_ferm:.1f} —Å–∞“ì", annotation_position="top left")
            fig_ferm.add_trace(go.Scatter(
                x=[t_target_ferm], y=[target_pH], mode='markers',
                marker=dict(size=10, color='red', symbol='star'),
                name='–ú–∞“õ—Å–∞—Ç—Ç—ã –Ω“Ø–∫—Ç–µ'
            ))

        fig_ferm.update_layout(
            title="–§–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏—è –∫–µ–∑—ñ–Ω–¥–µ–≥—ñ pH ”©–∑–≥–µ—Ä—É—ñ",
            xaxis_title="–£–∞“õ—ã—Ç (—Å–∞“ì–∞—Ç)",
            yaxis_title="pH",
            yaxis_range=[pH_inf - 0.2, pH_start + 0.2],
            height=400,
            template='plotly_white'
        )
        st.plotly_chart(fig_ferm, use_container_width=True)

        if 0 < t_target_ferm <= time_ferm:
            st.success(
                f"‚úÖ **–ù”ô—Ç–∏–∂–µ:** –ú–∞“õ—Å–∞—Ç—Ç—ã pH –¥–µ“£–≥–µ–π—ñ **{target_pH:.1f}**-“ì–∞ **{t_target_ferm:.1f} —Å–∞“ì–∞—Ç—Ç–∞** “õ–æ–ª –∂–µ—Ç–∫—ñ–∑—ñ–ª–µ–¥—ñ.")
        elif t_target_ferm > time_ferm:
            st.warning(
                f"‚ö†Ô∏è **–ï—Å–∫–µ—Ä—Ç—É:** –§–µ—Ä–º–µ–Ω—Ç–∞—Ü–∏—è {time_ferm} —Å–∞“ì–∞—Ç —ñ—à—ñ–Ω–¥–µ –º–∞“õ—Å–∞—Ç—Ç—ã pH-“õ–∞ –∂–µ—Ç–ø–µ–π–¥—ñ. $k_{{growth}}$ –Ω–µ–º–µ—Å–µ $pH_{{inf}}$ –º”ô–Ω–¥–µ—Ä—ñ–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.")

    # ====================================================================
    # TAB 3: –°–£–®–ö–ê (–ö–µ–ø—Ç—ñ—Ä—É) - –ú–µ–Ω—ñ“£ –∞–ª–¥—ã“£“ì—ã —Ç–æ–ª—ã“õ—Ç—ã—Ä—É—ã–º
    # ====================================================================
    with tab3:
        st.markdown("<h2 style='color:#667eea;'>3. –°—É—à–∫–∞ (–ö–µ–ø—Ç—ñ—Ä—É) –ø—Ä–æ—Ü–µ—Å—ñ–Ω—ñ“£ –º–æ–¥–µ–ª—ñ</h2>",
                    unsafe_allow_html=True)

        # --- –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –Ω–µ–≥—ñ–∑ ---
        st.subheader("üìö –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞–ª—ã“õ –Ω–µ–≥—ñ–∑")
        st.markdown("**1. –ö–µ–ø—Ç—ñ—Ä—É –∂—ã–ª–¥–∞–º–¥—ã“ì—ã (—ã–ª“ì–∞–ª–¥—ã“£ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª–¥—ã“õ –∂–æ“ì–∞–ª—É—ã):**")
        st.latex(r"W(t) = W_{eq} + (W_0 - W_{eq}) \cdot e^{-k_s t}")

        st.markdown(r"""
        **–ú“±–Ω–¥–∞:** $W(t)$ - —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ, $W_0$ - –±–∞—Å—Ç–∞–ø“õ—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ, $W_{eq}$ - —Ç–µ–ø–µ-—Ç–µ“£–¥—ñ–∫ —ã–ª“ì–∞–ª–¥—ã–ª—ã“ì—ã, 
        $k_s$ - –∫–µ–ø—Ç—ñ—Ä—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞—Å—ã, $t$ - —É–∞“õ—ã—Ç (—Å–∞“ì–∞—Ç).
        """)

        # --- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Å–∏–º—É–ª—è—Ü–∏—è ---
        st.subheader("‚öôÔ∏è –ö–µ–ø—Ç—ñ—Ä—É –¥–∏–Ω–∞–º–∏–∫–∞—Å—ã–Ω—ã“£ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤—Ç—ñ —Å–∏–º—É–ª—è—Ü–∏—è—Å—ã")

        col_s1, col_s2 = st.columns(2)

        # –ö–µ–ø—Ç—ñ—Ä—É –ø–∞—Ä–∞–º–µ—Ç—Ä–ª–µ—Ä—ñ
        with col_s1:
            W0 = st.slider("–ë–∞—Å—Ç–∞–ø“õ—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ ($W_0$, %)", 60.0, 75.0, 70.0, 0.5)
            W_eq = st.slider("–¢–µ–ø–µ-—Ç–µ“£–¥—ñ–∫ —ã–ª“ì–∞–ª–¥—ã–ª—ã“ì—ã ($W_{eq}$, %)", 15.0, 30.0, 25.0, 0.5)
            temp_dry = st.slider("–ö–µ–ø—Ç—ñ—Ä—É —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞—Å—ã ($T$, ¬∞C)", 15, 30, 22)

        with col_s2:
            air_flow = st.slider("–ê—É–∞ –∞“ì—ã–Ω—ã –∂—ã–ª–¥–∞–º–¥—ã“ì—ã ($V$, –º/—Å)", 0.1, 1.0, 0.5, 0.1)
            time_total = st.slider("–ñ–∞–ª–ø—ã —É–∞“õ—ã—Ç ($t_{max}$, —Å–∞“ì–∞—Ç)", 10, 500, 240, 10)
            target_W = st.number_input("–ú–∞“õ—Å–∞—Ç—Ç—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ ($W_{target}$, %)", 30.0, 60.0, 45.0, 1.0)

        # --- –ö–µ–ø—Ç—ñ—Ä—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞—Å—ã–Ω –µ—Å–µ–ø—Ç–µ—É (—ç–º–ø–∏—Ä–∏–∫–∞–ª—ã“õ) ---
        k_s_base = 0.005
        k_s_temp_factor = 1.0 + 0.04 * (temp_dry - 20)
        k_s_flow_factor = 1.0 + 0.5 * (air_flow - 0.5)
        k_s = k_s_base * k_s_temp_factor * k_s_flow_factor

        st.info(f"üîë **–ï—Å–µ–ø—Ç–µ–ª–≥–µ–Ω –∫–µ–ø—Ç—ñ—Ä—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞—Å—ã ($k_s$):** **{k_s:.4f} $h^{{-1}}$**")

        # --- –ú–æ–¥–µ–ª—å–¥–µ—É –µ—Å–µ–ø—Ç–µ—É—ñ ---
        t_values = np.linspace(0, time_total, 200)
        W_t = W_eq + (W0 - W_eq) * np.exp(-k_s * t_values)

        # --- –ú–∞“õ—Å–∞—Ç—Ç—ã —É–∞“õ—ã—Ç—Ç—ã –µ—Å–µ–ø—Ç–µ—É ---
        if W0 > target_W > W_eq:
            t_target = -1 / k_s * np.log((target_W - W_eq) / (W0 - W_eq))
        else:
            t_target = -1

        # --- –ì—Ä–∞—Ñ–∏–∫ —Ç“±—Ä“ì—ã–∑—É ---
        fig_dry = go.Figure()
        fig_dry.add_trace(go.Scatter(
            x=t_values, y=W_t, mode='lines', name='–´–ª“ì–∞–ª–¥—ã–ª—ã“õ –¥–∏–Ω–∞–º–∏–∫–∞—Å—ã (W(t))',
            line=dict(color='orange', width=3)
        ))

        # –ú–∞“õ—Å–∞—Ç—Ç—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ –¥–µ“£–≥–µ–π—ñ
        fig_dry.add_hline(y=target_W, line_dash="dash", line_color="green",
                          annotation_text=f"–ú–∞“õ—Å–∞—Ç: {target_W:.1f}%", annotation_position="top right")

        # –¢–µ–ø–µ-—Ç–µ“£–¥—ñ–∫ —ã–ª“ì–∞–ª–¥—ã–ª—ã“ì—ã
        fig_dry.add_hline(y=W_eq, line_dash="dot", line_color="gray",
                          annotation_text=f"$W_{{eq}}$: {W_eq:.1f}%", annotation_position="bottom right")

        # –ú–∞“õ—Å–∞—Ç—Ç—ã —É–∞“õ—ã—Ç –Ω“Ø–∫—Ç–µ—Å—ñ
        if 0 < t_target <= time_total:
            fig_dry.add_vline(x=t_target, line_dash="dash", line_color="red",
                              annotation_text=f"t (–º–∞“õ—Å–∞—Ç)={t_target:.1f} —Å–∞“ì", annotation_position="top left")
            fig_dry.add_trace(go.Scatter(
                x=[t_target], y=[target_W], mode='markers',
                marker=dict(size=10, color='red', symbol='star'),
                name='–ú–∞“õ—Å–∞—Ç—Ç—ã –Ω“Ø–∫—Ç–µ'
            ))

        fig_dry.update_layout(
            title="–ï—Ç ”©–Ω—ñ–º—ñ–Ω –∫–µ–ø—Ç—ñ—Ä—É –º–æ–¥–µ–ª—ñ",
            xaxis_title="–£–∞“õ—ã—Ç (—Å–∞“ì–∞—Ç)",
            yaxis_title="–´–ª“ì–∞–ª–¥—ã–ª—ã“õ (%)",
            yaxis_range=[W_eq - 5, W0 + 5],
            height=400,
            template='plotly_white'
        )
        st.plotly_chart(fig_dry, use_container_width=True)

        if 0 < t_target <= time_total:
            st.success(
                f"üéâ **–ù”ô—Ç–∏–∂–µ:** “ö–∞–∂–µ—Ç—Ç—ñ —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ –¥–µ“£–≥–µ–π—ñ **{target_W:.1f}%**-“ì–∞ **{t_target:.1f} —Å–∞“ì–∞—Ç—Ç–∞** “õ–æ–ª –∂–µ—Ç–∫—ñ–∑—ñ–ª–µ–¥—ñ.")
        elif t_target > time_total:
            st.warning(f"‚ö†Ô∏è **–ï—Å–∫–µ—Ä—Ç—É:** –ö–µ–ø—Ç—ñ—Ä—É {time_total} —Å–∞“ì–∞—Ç —ñ—à—ñ–Ω–¥–µ –º–∞“õ—Å–∞—Ç“õ–∞ –∂–µ—Ç–ø–µ–π–¥—ñ.")
        elif W0 <= target_W:
            st.error("‚ùå **“ö–∞—Ç–µ:** –ë–∞—Å—Ç–∞–ø“õ—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ –º–∞“õ—Å–∞—Ç—Ç—ã —ã–ª“ì–∞–ª–¥—ã–ª—ã“õ—Ç–∞–Ω —Ç”©–º–µ–Ω –Ω–µ–º–µ—Å–µ –æ“ì–∞–Ω —Ç–µ“£.")

